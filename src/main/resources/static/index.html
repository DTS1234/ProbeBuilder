<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <title>Test Configuration Form</title>
    <style>
        label {
            display: block;
            margin-top: 10px;
        }
    </style>
</head>
<body class="container bg-secondary-subtle">
<div class="row">
    <div class="col">
        <h2 class="mt-3">Test Configuration</h2>
        <h3 class="mt-3">Stress-ng Job</h3>

        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="flexCheckChecked" onclick="enableCommandMode()">
            <label class="form-check-label" for="flexCheckChecked">Command mode</label>
        </div>

        <form id="commandForm" style="display: none">
            <label class="form-label" for="stress-ng-command">Stress ng command</label>
            <input class="form-control" type="text" id="stress-ng-command" name="command">
        </form>

        <form id="testForm" class="mt-4">
            <!-- Test Specification Fields -->
            <label class="form-label" for="durationInSeconds">Duration (seconds):</label>
            <input class="form-control" type="number" id="durationInSeconds" name="durationInSeconds">

            <label class="form-label" for="cpuLoad">CPU Load:</label>
            <input class="form-control" type="number" id="cpuLoad" name="cpuLoad" max="100" min="1">

            <label class="form-label" for="vmWorkers">VM Workers:</label>
            <input class="form-control" type="number" id="vmWorkers" name="vmWorkers">

            <label class="form-label" for="mBytesRamLoad">RAM Load (MB):</label>
            <input class="form-control" type="number" id="mBytesRamLoad" name="mBytesRamLoad">

            <label class="form-label" for="IOworkers">IO Workers:</label>
            <input class="form-control" type="number" id="IOworkers" name="IOworkers">

            <label class="form-label" for="IOBytes">IO Bytes:</label>
            <input class="form-control" type="number" id="IOBytes" name="IOBytes">

            <button class="btn btn-primary mt-3" type="submit">Submit</button>
        </form>

    </div>
    <div class="col">
        <h2 class="mt-3">Json value</h2>
        <lable for="json-ng"><h3 class="mt-4">Stress ng json</h3></lable>
        <textarea rows=10 cols=100 id="json-ng" class="form-control mt-3"></textarea>
    </div>
</div>

<div class="row">
    <div class="col">

        <form id="fileForm" class="mt-4">
            <h3>File System Operations</h3>
            <label class="form-label" for="filesToCreate">Number of Files to Create:</label>
            <input class="form-control" type="number" id="filesToCreate" name="filesToCreate" required>

            <label class="form-label" for="fileContents">File Contents:</label>
            <textarea class="form-control" id="fileContents" name="fileContents" rows="5" required></textarea>

            <button class="btn btn-primary mt-3" type="submit">Submit</button>
        </form>

    </div>
    <div class="col">
        <label for="json-file"><h3 class="mt-3">File operations json</h3></label>
        <textarea rows=10 cols=100 id="json-file" class="form-control mt-3"></textarea>
    </div>
</div>

<div class="row">
    <div class="col">
        <form id="payloadForm" onclick="generatePayload()" class="mt-4">
            <h3>Dummy payload</h3>

            <label class="form-label" for="fieldsNumber">Fields number:</label>
            <input class="form-control" type="number" id="fieldsNumber" name="fieldsNumber" min="1" required>
            <button class="btn btn-primary mt-3" type="button" onclick="generatePayload()">Submit</button>

        </form>
    </div>
    <div class="col">
        <label for="json-payload"><h3 class="mt-3">Dummy payload json</h3></label>
        <textarea rows=10 cols=100 id="json-payload" class="form-control mt-3"></textarea>
    </div>
</div>

<div class="row">
    <h2 class="mx-auto mt-4 mb-4">Jmeter launcher</h2>
    <div class="col-4">
        <form id="jmeterForm">
            <label class="form-label" for="numberOfThreads">Number of Threads:</label>
            <input class="form-control" type="number" id="numberOfThreads" name="numberOfThreads" required><br>

            <label class="form-label" for="rampUpPeriod">Ramp-Up Period:</label>
            <input class="form-control" type="number" id="rampUpPeriod" name="rampUpPeriod" required><br>

            <label class="form-label" for="ip">IP:</label>
            <input value="localhost" class="form-control" type="text" id="ip" name="ip" required><br>

            <label class="form-label" for="port">Port:</label>
            <input value="8080" class="form-control" type="number" id="port" name="port" required><br>

            <label class="form-label" for="path">Path:</label>
            <input value="api/load" class="form-control" type="text" id="path" name="path" required><br>

            <label class="form-label" for="method">Method:</label>
            <input value="POST" class="form-control" type="text" id="method" name="method" required><br>

            <label class="form-label" for="body">Body:</label>
            <textarea class="form-control" id="body" name="body" rows="5" required></textarea><br>

            <button class="btn btn-primary mt-3" type="button" onclick="launchJmeter()">Submit</button>
        </form>
    </div>
    <div class="col-8 mr-4">
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>Date</th>
                <th>JTL File</th>
                <th>Number of threads</th>
                <th>Ramp up period</th>
                <th>Test type</th>
            </tr>
            </thead>
            <tbody id="results"></tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>

    function enableCommandMode() {

        let testForm = document.getElementById("testForm");
        let commandForm = document.getElementById("commandForm");
        console.log("I'm here !")
        console.log(testForm)

        if (testForm.style.display === "none") {
            testForm.style.display = "block"
            commandForm.style.display = "none"
        } else {
            testForm.style.display = "none";
            commandForm.style.display = "block"
        }

    }

    document.getElementById("stress-ng-command").addEventListener("change", submitCommand)

    function submitCommand() {
        if (document.getElementById("flexCheckChecked").checked === true) {
            document.getElementById("json-ng").innerText = JSON.stringify({"isCommand": true, "command": document.getElementById("stress-ng-command").value})
        }
    }

    document.getElementById("fileForm").addEventListener("submit", function (event) {
        event.preventDefault();

        var fileSystemSpecification = {
            filesToCreate: parseInt(document.getElementById("filesToCreate").value),
            fileContents: document.getElementById("fileContents").value.split("\n")
        };

        // Do something with the specifications (e.g., send to the server)
        console.log(fileSystemSpecification);
        document.getElementById("json-file").innerText = JSON.stringify(fileSystemSpecification);

        // Reset the form
        document.getElementById("fileForm").reset();

    })

    document.getElementById("testForm").addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent form submission

        // Get form values
        var testSpecification = {
            durationInSeconds: parseInt(document.getElementById("durationInSeconds").value),
            cpuLoad: parseInt(document.getElementById("cpuLoad").value),
            vmWorkers: parseInt(document.getElementById("vmWorkers").value),
            mBytesRamLoad: parseInt(document.getElementById("mBytesRamLoad").value),
            IOworkers: parseInt(document.getElementById("IOworkers").value),
            IOBytes: parseInt(document.getElementById("IOBytes").value)
        };

        // Do something with the specifications (e.g., send to the server)
        console.log(testSpecification);
        document.getElementById("json-ng").innerText = JSON.stringify(testSpecification);

        // Reset the form
        document.getElementById("testForm").reset();
    });

    function launchJmeter() {

        var form = document.getElementById("jmeterForm");
        var formData = new FormData(form);

        var jsonObject = {};

        for (var [key, value] of formData.entries()) {
            if (value != null || value !== "null") {
                jsonObject[key] = value;
            }
        }

        var jsonPayload = JSON.stringify(jsonObject);


        var xhr = new XMLHttpRequest();

        xhr.open("POST", "http://localhost:4040/run");
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(jsonPayload);
    }

    function generatePayload() {
        // Get the input value
        var fieldsNumber = parseInt(document.getElementById('fieldsNumber').value);

        // Create an object to hold the key-value pairs
        var payload = {}

        // Generate the key-value pairs
        for (var i = 1; i <= fieldsNumber; i++) {
            var key = 'key' + i;
            var value = 'value' + i;
            payload[key] = value
        }

        // Convert the object to JSON
        var payloadJson = JSON.stringify(payload);
        payloadJson = payloadJson.replace(/\\/g, '');

        // Output the JSON payload
        document.getElementById("json-payload").innerText = payloadJson;
    }

</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Function to update the results
        function updateResults() {
            $.ajax({
                url: 'http://localhost:4040/results',
                type: 'GET',
                success: function (data) {
                    // Generate HTML table rows dynamically based on the received data
                    var rows = '';
                    Object.keys(data).forEach(function (key) {
                        var result = data[key];
                        var className = result.done === true ? "bg-success" : "bg-danger"

                        rows += '<tr>';
                        rows += '<td class=' + className + '>' + result.date + '</td>';
                        rows += '<td>' + result.jtlFile + '</td>';
                        rows += '<td>' + result.numberOfThreads + '</td>';
                        rows += '<td>' + result.rampUpPeriod + '</td>';
                        rows += '<td>' + result.testType + '</td>';
                        rows += '</tr>';
                    });

                    // Update the HTML table body with the generated rows
                    $('#results').html(rows);
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching results:', error);
                }
            });
        }

        // Initial call to update results
        updateResults();

        // Set interval to periodically update the results every 10 seconds
        setInterval(updateResults, 10000);
    });
</script>

</body>
</html>
